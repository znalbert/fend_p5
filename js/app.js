var Event=function(e){this.title=ko.observable(e.title),this.venue=ko.observable(e.venue_name),this.url=ko.observable(e.url),this.venue_url=ko.observable(e.venue_url),this.venue_address=ko.observable(e.venue_address),this.city_name=ko.observable(e.city_name),this.state=ko.observable(e.region_name),this.lat=ko.observable(e.latitude),this.lng=ko.observable(e.longitude),this.category=ko.observable(e.categories.category[0].name)},ViewModel=function(){var e,o=this;o.eventList=ko.observableArray([]),o.markerList=ko.observableArray([]),o.coords={},o.bounds=new google.maps.LatLngBounds,o.pageNumber=ko.observable(1),o.filter=ko.observable(""),o.pageCount=ko.observable(""),o.prevBtn=ko.observable(!1),o.nextBtn=ko.observable(!0),o.showEventNav=ko.observable(!1),o.getGeoLocation=function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){o.coords.lat=e.coords.latitude,o.coords.lng=e.coords.longitude,o.map(),o.getEvents(o.pageNumber())})},o.getLocationManually=function(){var e="https://maps.googleapis.com/maps/api/geocode/json?",t="key=AIzaSyAZKV6_aryLoI5q40ikKRJ_Qy-32Hg-3ng&address=",n=$("#city").val(),a=e+t+n;o.bounds=new google.maps.LatLngBounds,$.getJSON(a,function(e){pos=e.results[0].geometry.location,o.coords.lat=pos.lat,o.coords.lng=pos.lng,o.map(),o.getEvents(o.pageNumber())})},o.map=function(){map=new google.maps.Map(document.getElementById("map"),{center:o.coords,zoom:13,disableDefaultUI:!0}),e=new google.maps.InfoWindow({content:null})},o.getEvents=function(e){var t="https://api.eventful.com/json/events/search?app_key=",n="VN3TDSXzQdSQK2rD",a="&date=Today&sort_order=popularity&within=20",s="&include=categories,popularity",r="&location="+o.coords.lat+","+o.coords.lng,i="&page_number="+e,l=t+n+a+s+i+r;console.log(l),$.ajax({url:l,dataType:"jsonp",success:function(e){o.eventList([]),o.markerList([]),console.log(e),o.pageCount(e.page_count),o.pageCount()>1&&o.showEventNav(!0),console.log(o.pageCount()),console.log(o.showEventNav()),e.events.event.forEach(o.eventView),o.eventList().forEach(o.createMarker)}})},o.getNextEvents=function(){o.map(),o.pageNumber(o.pageNumber()+1),o.getEvents(o.pageNumber()),o.prevBtn(!0),o.pageNumber()==o.pageCount()&&o.nextBtn(!1)},o.getPrevEvents=function(){o.map(),o.pageNumber(o.pageNumber()-1),o.getEvents(o.pageNumber()),1==o.pageNumber&&o.prevBtn(!1)},o.eventView=function(e,t,n){o.eventList.push(new Event(e));var a={lat:Number(e.latitude),lng:Number(e.longitude)},s=new google.maps.LatLng(a);o.bounds.extend(s),map.fitBounds(o.bounds)},o.createMarker=function(t,n,a){var s=new google.maps.LatLng(t.lat(),t.lng()),r=new google.maps.Marker({position:s,map:map,title:t.venue(),animation:google.maps.Animation.DROP});google.maps.event.addListener(r,"click",function(){var n=this;console.log(o.filteredEvents()),e.setContent(t.title()+"<br>"+t.category()+"<br><a href="+t.url()+">Link</a>"),e.open(map,n),map.panTo(n.position)}),google.maps.event.addListener(e,"closeclick",function(){map.panTo(o.bounds.getCenter()),map.fitBounds(o.bounds)}),o.markerList.push(r)},o.moveToMarker=function(){google.maps.event.trigger(this,"click")},o.filteredEvents=ko.computed(function(){return ko.utils.arrayFilter(o.markerList(),function(e){return-1!==e.title.toLowerCase().indexOf(o.filter().toLowerCase())})},o),o.filteredEvents.subscribe(function(){var e=ko.utils.compareArrays(o.markerList(),o.filteredEvents());ko.utils.arrayForEach(e,function(e){"deleted"===e.status?e.value.setMap(null):e.value.setMap(map)})}),o.getGeoLocation()};ko.applyBindings(new ViewModel);